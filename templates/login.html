<!DOCTYPE html>
<html lang="eng">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
        <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
        <style>
            body{
                font-family: Helvetica;
            }

            #Login{
                margin-top: 30vh;
                overflow: auto;
            }

            a{
                text-decoration: none;
            }
        </style>
    </head>

    <body class="bg-light">
        <div class="container d-flex align-items-center justify-content-center min-vh-100">
            <div class="col-12 col-sm-10 col-md-6 col-lg-4">
                <div class="card shadow border-0 rounded-3">
                    <div class="card-body p-4">
                        
                        <!-- Title -->
                        <div id="Title" class="mb-4">
                            <h4 class="text-center text-primary fw-bold">ZIMBABWE LAND REGISTRY</h4>
                            <p class="text-center text-secondary mb-0 fs-5">Login</p>
                        </div>
                        
                        <!-- Form -->
                        <form method="POST" action="{% url 'authentication:login'%}">
                            {% csrf_token %}
                            <!-- Email -->
                            <div class="form-floating mb-3">
                                <input type="email" name="email" id="email" class="form-control" placeholder="Enter Email" required>
                                <label for="email">Email address</label>
                            </div>

                            <!-- Password -->
                            <div class="form-floating mb-3">
                                <input type="password" name="password" id="password" class="form-control" placeholder="Enter Password" required>
                                <label for="password">Password</label>
                            </div>

                            <!-- Login Button -->
                            <div class="d-grid mb-3">
                                <div onclick="login()" class="btn btn-primary btn-lg">
                                    LogIn
                                    <div class="d-none spinner-border spinner-border-sm" id="spinner"></div>
                                </div>
                            </div>

                            <!-- Links -->
                            <div class="text-center">
                                <a href="{% url 'authentication:signup' %}" class="text-decoration-none">Sign Up</a> / 
                                <a href="#" class="text-decoration-none">Forgot Password?</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="liveToast" 
            class="toast hide position-fixed top-0 end-0 m-3 shadow-lg rounded-3 w-50" 
            role="alert" aria-live="assertive" aria-atomic="true">

            <div class="toast-header bg-success text-white rounded-3">
                <i class="bi bi-check-circle-fill me-2"></i>
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close btn-close-white ms-2 mb-1" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>

        <div id="liveToastFail" 
            class="toast hide position-fixed top-0 end-0 m-3 shadow-lg rounded-3 w-50" 
            role="alert" aria-live="assertive" aria-atomic="true">

            <div class="toast-header bg-danger text-white rounded-3">
                <i class="bi bi-x-circle-fill me-2"></i>
                <strong class="me-auto">Failed</strong>
                <button type="button" class="btn-close btn-close-white ms-2 mb-1" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>


        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script>  
            const toastEl = document.getElementById('liveToast');
            const toastElF = document.getElementById('liveToastFail');
            
            const toast = new bootstrap.Toast(toastEl, {
                delay: 2000
            });

            const toastFail = new bootstrap.Toast(toastElF, {
                delay: 2000
            });

            function dashboard(){
                window.location.href = "{% url 'dashboard:dashboard' %}";
            }

            function login(){
                data = {
                    email: document.getElementById('email').value,
                    password: document.getElementById('password').value
                };
                console.log(data);

                spinner_btn = document.getElementById('spinner'),
                spinner_btn.classList.remove('d-none'),

                fetch("{% url 'authentication:login' %}", {
                    method: 'POST',
                    headers: {
                        'ContentType': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                }).then(response => response.json())
                .then(data => {
                    if(data.success){
                        toast.show();
                        dashboard();
                    }else{
                        toastFail.show();
                    }
                })
            }

            function getCookie(name) {
                const cookieArr = document.cookie.split(";"); // split all cookies
                for (let cookie of cookieArr) {
                    cookie = cookie.trim(); // remove whitespace
                    // Check if this cookie string starts with the name we want
                    if (cookie.startsWith(name + "=")) {
                        return decodeURIComponent(cookie.substring(name.length + 1));
                    }
                }
                return null; // Cookie not found
            }
        </script>
    </body>

</html>